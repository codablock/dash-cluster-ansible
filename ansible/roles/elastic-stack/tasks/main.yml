---

- name: increase VM max map count to ES minimum
  sysctl:
    name: vm.max_map_count
    value: 262144
    state: present

- name: create elastic services and certs dirs
  file:
    path: '{{ certs_path }}/{{ inventory_hostname }}'
    state: directory
    recurse: true

# Generate certificates on first logs node
- import_tasks: generate-certs.yml
  run_once: true
  delegate_to: '{{ play_hosts|first }}'

- name: fetch generated certs
  run_once: true
  fetch:
    src: '{{ bundle_path }}/bundle.zip'
    dest: /tmp/ansible/{{ dash_network_name }}/
    flat: true

- name: install certs
  unarchive:
    src: /tmp/ansible/{{ dash_network_name }}/bundle.zip
    dest: '{{ certs_path }}'
    include: [ '{{ inventory_hostname }}/*', 'ca/ca.crt' ]

- name: copy files
  vars:
    template_seeds: "{{ groups.logs_nodes | reject('equalto', inventory_hostname) }}"
  template:
    src: '{{ item }}.j2'
    dest: '{{ elastic_path }}/{{ item }}'
  loop:
    - docker-compose.yml
    - elasticsearch.yml
    - kibana.yml

- name: start elastic services
  docker_compose:
    project_src: '{{ elastic_path }}'
    state: present
    pull: yes
    restarted: yes

- name: Wait for Elastic Stack to be available
  uri:
    url: http://localhost:9200
    user: "{{ elastic_username }}"
    password: "{{ elastic_password }}"
  register: response
  until: response.status == 200
  retries: 10
  delay: 10

# Configure Elasticsearch and Kibana
- import_tasks: configure-cluster.yml
  run_once: true
  delegate_to: '{{ play_hosts|first }}'
