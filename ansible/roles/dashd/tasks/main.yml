---

- name: Create dashd group
  group:
    name: '{{ dashd_group }}'

- name: Create dashd user
  user:
    name: '{{ dashd_user }}'
    comment: 'Dash user'
    group: '{{ dashd_group }}'
    home: '{{ dashd_home }}'
    create_home: yes
    umask: '0002'
  register: dash_user

- name: create .dashcore directory for each user
  file:
    path: "{{ item.dir }}/.dashcore"
    state: "directory"
    mode: 0755
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
  loop: "{{ users_to_manage }}"

- name: Write dash.conf file in /etc/
  template:
    src: 'dash.conf.j2'
    dest: '/etc/dash.conf'
    owner: 'root'
    group: 'root'
    mode: 0644
  register: dash_config_state

- name: Symlink dash.conf to user dashcore directories to make rpc work
  file:
    path: "{{ item.dir }}/.dashcore/dash.conf"
    src: "/etc/dash.conf"
    state: link
    force: yes
  loop: "{{ users_to_manage }}"

- name: Create dashcore docker-compose dir
  file:
    path: '{{ dashd_compose_path }}'
    state: directory
    mode: 0755
    recurse: true

- name: Copy dashcore docker-compose file
  template:
    src: '{{ item }}.j2'
    dest: '{{ dashd_compose_path }}/{{ item }}'
    mode: 0644
  loop:
    - docker-compose.yml
    - .env

- name: Configure log rotation
  include_role:
    name: arillso.logrotate
  vars:
    logrotate_applications:
      - name: core-logs
        definitions:
          - logs:
              - "{{ dashd_home }}/.dashcore/{{ dash_network_name if dash_network == 'devnet' else 'testnet3' }}/debug.log"
            options:
              - rotate 7
              - daily
              - maxsize 1G
              - missingok
              - notifempty
              - copytruncate
              - compress
              - delaycompress

- name: Ensure logrotate runs hourly under systemd timer
  lineinfile:
    path: /lib/systemd/system/logrotate.timer
    regexp: '^OnCalendar=hourly'
    insertafter: '^OnCalendar=daily'
    line: OnCalendar=hourly

- name: Enable and restart logrotate systemd timer
  systemd:
    name: logrotate.timer
    state: restarted
    enabled: yes
    daemon_reload: true

- name: Start dash core
  docker_compose:
    project_src: '{{ dashd_compose_path }}'
    state: present
    restarted: yes
    pull: yes

- name: wait for rpc to be available
  shell: dash-cli getgovernanceinfo
  register: task_result
  until: task_result.rc == 0
  retries: 5
  delay: 10
