#!/usr/bin/env bash

set -ea

. ./lib/cli/utils.sh

CMD_USAGE="Destroy Dash Network

Usage: destroy [options] <network_name>

Options:
  -t --target              - Select target, currently supports 'all' which will destroy infrastructure, 'network' which will destroy all configs but keep infrastructure and 'platform' which will destroy platform only
  -h --help                - Show help"

for i in "$@"
do
case ${i} in
    -t*|--target=*)
    TARGET="${i#*=}"
    ;;
    -h|--help)
        echo "$CMD_USAGE"
        exit 0
    ;;
    *)
    NETWORK_NAME="${i#*=}"
    ;;
esac
done

declare -a arr=("all" "network" "platform")
[[ " ${arr[*]} " =~ " $TARGET " ]] && echo "Destroying $TARGET" || echo "Target not found"

. ./lib/cli/init.sh
. ./lib/cli/terraform.sh
. ./lib/cli/ansible.sh

if [ $TARGET == "all" ]; then
    terraform_run_command "destroy"
    rm "networks/$NETWORK_NAME.inventory"
else
    echo "Removing software and configuration and keeping infrastructure..."
    ansible_run_playbook "-e target={$TARGET} destroy.yml"
fi
